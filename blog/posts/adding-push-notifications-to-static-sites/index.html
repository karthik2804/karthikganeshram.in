<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>
			Adding push notifications to static sites | Karthik Ganeshram</title>
		<meta name="description" content="Karthik Ganeshram's personal website where I share my thoughts! In part-1, the tools and general structure of the implementation of push notifications on a static site using cloudflare workers and FCM is discussed.">
		<meta property="og:title" content="Adding push notifications to static sites"/>
		<meta property="og:url" content="karthikganeshram.in/blog/posts/adding-push-notifications-to-static-sites/"/>
		<meta property="og:description" content="In part-1, the tools and general structure of the implementation of push notifications on a static site using cloudflare workers and FCM is discussed."/>
		<meta name="twitter:card" content="summary_large_image"></meta>
		<meta property="og:image" content="https://karthikganeshram.in/assets/images/NotificationMain.png" />
		<meta property="og:site_name" content="Karthik Ganeshram">
		<meta name="twitter:image:alt" content="Comments section in a static site ">
		<meta name="author" content="Karthik Ganeshram">
		<link rel="stylesheet" href="/assets/css/index.css">
		<link rel="shortcut icon" href="/assets/images/logo.png" type="image/png">
	</head>

	<body>
		<div id="themepicker" class="themepicker" data-nosnippet="">
    <div class="title tc">Select Theme</div>
    <div style="cursor:pointer;position:absolute;right: 0px;top:0px;padding:1rem;font-size:1.125rem;font-weight:500;" onclick="toggleThemeSelection()">X</div>
    <div class="list flex" id="theme-menu">
        
        <div class="item pa1" id="default" onclick='switchTheme("default")'>
          <button class="themepicker__btn" data-theme="default" aria-label="select color theme 'Classic'">
            <span class="name">Classic</span>
            <span class="themepicker__palette">
              <span class="themepicker__hue themepicker__hue--primary"></span>
              <span class="themepicker__hue themepicker__hue--secondary"></span>
              <span class="themepicker__hue themepicker__hue--border"></span>
              <span class="themepicker__hue themepicker__hue--textoffset"></span> 
              <span class="themepicker__hue themepicker__hue--text"></span></span>
          </button>
        </div>
        
        <div class="item pa1" id="dark" onclick='switchTheme("dark")'>
          <button class="themepicker__btn" data-theme="dark" aria-label="select color theme 'Dark'">
            <span class="name">Dark</span>
            <span class="themepicker__palette">
              <span class="themepicker__hue themepicker__hue--primary"></span>
              <span class="themepicker__hue themepicker__hue--secondary"></span>
              <span class="themepicker__hue themepicker__hue--border"></span>
              <span class="themepicker__hue themepicker__hue--textoffset"></span> 
              <span class="themepicker__hue themepicker__hue--text"></span></span>
          </button>
        </div>
        
        <div class="item pa1" id="light2" onclick='switchTheme("light2")'>
          <button class="themepicker__btn" data-theme="light2" aria-label="select color theme 'Alternate Light'">
            <span class="name">Alternate Light</span>
            <span class="themepicker__palette">
              <span class="themepicker__hue themepicker__hue--primary"></span>
              <span class="themepicker__hue themepicker__hue--secondary"></span>
              <span class="themepicker__hue themepicker__hue--border"></span>
              <span class="themepicker__hue themepicker__hue--textoffset"></span> 
              <span class="themepicker__hue themepicker__hue--text"></span></span>
          </button>
        </div>
        
        <div class="item pa1" id="dark2" onclick='switchTheme("dark2")'>
          <button class="themepicker__btn" data-theme="dark2" aria-label="select color theme 'Alternate Dark'">
            <span class="name">Alternate Dark</span>
            <span class="themepicker__palette">
              <span class="themepicker__hue themepicker__hue--primary"></span>
              <span class="themepicker__hue themepicker__hue--secondary"></span>
              <span class="themepicker__hue themepicker__hue--border"></span>
              <span class="themepicker__hue themepicker__hue--textoffset"></span> 
              <span class="themepicker__hue themepicker__hue--text"></span></span>
          </button>
        </div>
        
        </div>
</div>
		<div class="h-100 columns justify-center">
			<div class="col-12 h-100 flex flex-column">
				<div class="columns w-100 justify-center mb2">
	<div class="column col-10 col-sm-12">
		<div class="nav">
			<div class="logo h-100">
				<a class="h-100" href="/"><?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg height="100%" version="1.1" viewBox="0 0 107.44 107.44" xmlns="http://www.w3.org/2000/svg">
 <g transform="translate(-35.103 -75.079)">
  <g>
   <rect transform="rotate(45)" x="117.22" y="-8.3963" width="73.327" height="73.327" fill="none" stroke-width="2.6458"/>
   <path d="m78.76 139.09 20.129-20.587" stroke-width="2.6458"/>
   <g transform="translate(-.014667 -1.4649)" font-family="'DejaVu Sans'" font-size="32.947px" letter-spacing="0px" stroke-width=".26458" word-spacing="0px">
    <text x="63.220253" y="129.422" style="line-height:1.25" xml:space="preserve"><tspan x="63.220253" y="129.422" font-family="sans-serif" stroke-width=".26458">K</tspan></text>
    <text x="88.396034" y="154.66121" style="line-height:1.25" xml:space="preserve"><tspan x="88.396034" y="154.66121" font-family="sans-serif" stroke-width=".26458">G</tspan></text>
   </g>
  </g>
 </g>
</svg>
</a>
			</div>
			<div class="flex-grow-1 flex  justify-end nav-links">
				
					<a class="nav-item " href="/">Home</a>
				
					<a class="nav-item active" href="/blog">Blog</a>
				
					<a class="nav-item " href="/about">About</a>
				
			</div>
			<span class="d-flex nav-item" style="align-items:center;font-size:1.25rem;margin-right:1rem;cursor:pointer;" id="ThemeSwitch" onclick="toggleThemeSelection()">
				<span style="display:flex;justify-content:center;align-items:center;border-radius:50%;width:3rem;height:3rem;background:var(--color-bg-offset)">
					<svg style="fill:var(--color-text)" class="icon icon--theme" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" role="img" aria-hidden="true"><path d="M18 4V3c0-.55-.45-1-1-1H5c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1h12c.55 0 1-.45 1-1V6h1v4H9v11c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-9h8V4h-3z"></path></svg>
				</span>
			</span>
				
			<div class="hamburger">
				<div class="line1"></div>
				<div class="line2 line2-left"></div>
				<div class="line2 line2-right"></div>
				<div class="line3"></div>
			</div>
		</div>
	</div>
</div>
				<div class="flex-grow-1">
					





<div class="columns col-gapleess flex-columns justify-center">
	<div class="column col-6 col-md-12 pa1">
		<h1 class="post-title">Adding push notifications to static sites</h1>
		<span><a class="chip" href="/blog/tags/tech/0">Tech</a></span>
		<div>Jun 5, 2021</div>
	</div>
	<div class="column col-12">
		
		<p><img src="/assets/images/NotificationMain.png" alt="Notification toggle on a static eleventy site" class="img-responsive" loading="lazy" width="641" height="361"> <em>Notification toggle on a static eleventy site</em></p>

		
	</div>
	<div class="column col-3 hide-md pa1 post-content"></div>
	<div class="column col-6 col-md-12 pa1 post-content">
		<p>While reading about cloudflare workers, I had this thought of can I use this to trigger push notifications for my static site that has a blog. That is what I did. In this post. I will describe the steps involved in creating push notifications using Firebase Cloud Messaging and Cloudflare workers. This post must not be considered as a tutorial but merely as a guide.</p>
<p>Cloudflare workers allows us to write serverless code that allows us to build API using the edge nodes of cloudflare. We will create an API that will allow the users of the site to subscribe/unsubscribe to new post notifications. We will also use the ability of CRON triggers to automate sending notifications.</p>
<p><a href="https://firebase.google.com/docs/cloud-messaging">FCM</a> API allows us to send push messages to the clients to update them of new data and this is exactly what we will be using to send notifications when there are new posts in our static site. We will also use their library on the front-end to handle notifications.</p>
<h2>Firebase Cloud Messaging</h2>
<p>First we will need to add the library to our web app. They can be included using the script tags and it must be initiated. Refer to the <a href="https://firebase.google.com/docs/cloud-messaging/js/client">official documentation</a> for additional information. Make sure to create a project in firebase if you have not already done it.</p>
<h6>index.html</h6>
<pre class="language-html"><code class="language-html">.....<br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://www.gstatic.com/firebasejs/8.5.0/firebase-app.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://www.gstatic.com/firebasejs/8.6.2/firebase-messaging.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>....</code></pre>
<h6>index.js</h6>
<pre class="language-js"><code class="language-js"><span class="token comment">// Your web app's Firebase configuration</span><br><span class="token comment">// For Firebase JS SDK v7.20.0 and later, measurementId is optional</span><br><span class="token keyword">var</span> firebaseConfig <span class="token operator">=</span> <span class="token punctuation">{</span><br>	<span class="token comment">/* enter your firebase project details */</span><br><span class="token punctuation">}</span><br>firebase<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span>firebaseConfig<span class="token punctuation">)</span><br><span class="token comment">// Using a redirect.</span></code></pre>
<p>Also create a file named &quot;firebase-messaging-sw.js&quot;. This file will contain the service worker that will handle sending notifications when it receives data from FCM. Initialize it with the following contents. We will fill in the rest later.</p>
<h6>firebase-messaging-sw.js</h6>
<pre class="language-js"><code class="language-js"><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js'</span><span class="token punctuation">)</span><br><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'https://www.gstatic.com/firebasejs/8.6.2/firebase-messaging.js'</span><span class="token punctuation">)</span><br><br><span class="token keyword">let</span> firebaseConfig <span class="token operator">=</span> <span class="token punctuation">{</span><br>	<span class="token comment">/* enter your firebase project configurations */</span><br><span class="token punctuation">}</span><br>firebase<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span>firebaseConfig<span class="token punctuation">)</span><br><span class="token keyword">const</span> messaging <span class="token operator">=</span> firebase<span class="token punctuation">.</span><span class="token function">messaging</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Now that the initial setup of firebase is done in the client let us understand how FCM works. So when a client wants to show notifications, it requires the user to allow notifications on the website. Once the notification permission is avaibale, the messaging library of firebase can create a registration token for the user. This token is then shared with the server. The token can be used to send messages to specific devices or can be registed with FCM notifications to subscribe to a topic.</p>
<p>We will Be registering the token on a topic since, it is a common notification that we desire to all the users. So now let us add the functionality to create the registration token. The vapidKey is available in the cloud messaging tab of the project settings in firebase console.</p>
<p><img src="/assets/images/FCM.jpg" alt="Firebase Cloud Messaging console" loading="lazy" width="1280" height="719"><em>FCM console</em></p>
<h6>index.js</h6>
<pre class="language-js"><code class="language-js"><span class="token operator">...</span><br><br><span class="token keyword">let</span> notificationToken<br><span class="token keyword">let</span> notificationStatus <span class="token operator">=</span> <span class="token boolean">false</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">getToken</span> <span class="token operator">=</span>  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token keyword">await</span> messaging<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'&lt;YOUR_PUBLIC_VAPID_KEY_HERE>'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token keyword">return</span> token<br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">!=</span> <span class="token string">"blocked"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		notificationToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>notificationToken<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>This script will now initially check if the notification permissions are blocked, else it will trigger the firebase function to get the token. If the permissions for notification is not granted, it will request for it. It is better to trigger the <code>getToken</code> on the request of the user, this is just to show the process.</p>
<p>Now we have the FCM registration token, we can look at the FCM API. We will be needing 4 APIs to get push notifications to work. We will need an API for registering and unregistering a user to topic, an API to check the status of the user and finally and most importantly the API that will allow us to push notifications to specific topics.</p>
<p>The reason we need to use REST APIs and not the firebase-admin package in nodejs is because that pacakge cannot be used in cloudflare workers as it depends on certain node specific features which are not available on workers.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// FCM API</span><br><br><span class="token comment">// get user status</span><br><span class="token comment">// SERVER_KEY available in firebase cloud messaging tab</span><br><span class="token comment">// IID Token is the firebase messaging registration token</span><br><span class="token comment">// Return an object on success, we are interested in the "rel" key containing the topics subscribed</span><br><br>statusURL <span class="token operator">=</span> <span class="token string">"https://iid.googleapis.com/iid/info/&lt;FCM_REGISTRATION_TOKEN>"</span><br>statusParameters <span class="token operator">=</span> <span class="token punctuation">{</span><br>	<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"key=&lt;SERVER_KEY>"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Sub user </span><br><span class="token comment">// API_KEY is the same as SERVER_KEY</span><br><span class="token comment">// TOPIC is the name to which we want to subscribe the user to</span><br><br><span class="token keyword">let</span> suburl <span class="token operator">=</span> <span class="token string">"https://iid.googleapis.com/iid/v1:batchAdd"</span><br>subParameters <span class="token operator">=</span> <span class="token punctuation">{</span><br>	<span class="token string-property property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>		<span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span><br>		<span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"key=&lt;API_KEY>"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>	<span class="token string-property property">"body"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  	<span class="token string-property property">"to"</span><span class="token operator">:</span> <span class="token string">"&lt;TOPIC>"</span><span class="token punctuation">,</span><br>   	<span class="token string-property property">"registration_tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;FCM_REGISTRATION_TOKEN>"</span><span class="token punctuation">]</span><br>	<span class="token punctuation">}</span><span class="token punctuation">,</span><br>	<span class="token string-property property">"method"</span><span class="token operator">:</span> <span class="token string">"POST"</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// unSub user </span><br><span class="token comment">// API_KEY is the same as SERVER_KEY</span><br><span class="token comment">// TOPIC is the name to which we want to subscribe the user to</span><br><br><span class="token keyword">let</span> unsubURL <span class="token operator">=</span> <span class="token string">"https://iid.googleapis.com/iid/v1:batchRemove"</span><br>unsubParameters <span class="token operator">=</span> <span class="token punctuation">{</span><br>	<span class="token string-property property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>		<span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span><br>		<span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"key=&lt;API_KEY>"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>	<span class="token string-property property">"body"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  	<span class="token string-property property">"to"</span><span class="token operator">:</span> <span class="token string">"&lt;TOPIC>"</span><span class="token punctuation">,</span><br>  	<span class="token string-property property">"registration_tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;FCM_REGISTRATION_TOKEN>"</span><span class="token punctuation">]</span><br>	<span class="token punctuation">}</span><span class="token punctuation">,</span><br>	<span class="token string-property property">"method"</span><span class="token operator">:</span> <span class="token string">"POST"</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Send notification</span><br><span class="token comment">// GOOGLE_OAUTH_ACCESS_TOKEN is needed </span><br><br><span class="token keyword">let</span> topicNotificationURL <span class="token operator">=</span><span class="token string">"https://fcm.googleapis.com/v1/projects/329859626245/messages:send"</span><br><span class="token keyword">let</span> topicNotificationParameter <span class="token operator">=</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>			<span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>				<span class="token string-property property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">"body"</span><span class="token operator">:</span> data<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"New Post!"</span><span class="token punctuation">,</span> <span class="token string-property property">"image"</span><span class="token operator">:</span> <span class="token string">"https://karthikganeshram.in"</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>image<span class="token punctuation">,</span> <span class="token string-property property">"tag"</span><span class="token operator">:</span> data<span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token string-property property">"url"</span><span class="token operator">:</span> <span class="token string">"https://karthikganeshram.in"</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token punctuation">,</span><br>				<span class="token string-property property">"topic"</span><span class="token operator">:</span> <span class="token string">"newPost"</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>			<span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> <span class="token constant">GOOGLE_OAUTH_ACCESS_TOKEN</span><span class="token punctuation">,</span><br>			<span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><br>	<span class="token punctuation">}</span></code></pre>
<p>I decided to use the batch api for add and remove as I was not able to find the remove api for a single token and wanted to maintain consitency in the API. Now we can test out the commands using curl. We have everything required to test the API except the <code>GOOGLE_OAUTH_ACCESS_TOKEN</code>. The method to obtain it will be explained soon. In the meantime you can use the &quot;Notifcation composer&quot; in firebase console to send test messages after you get the registration token.</p>
<h2>Cloudflare workers</h2>
<p>Now it is time to move onto workers. It is assumed that the reader has some familiarity with the basics of cloudflare workers. If not don't worry, the <a href="https://developers.cloudflare.com/workers/">documentation and examples</a> will get you started. As explained earlier we will have to use REST APIs instead of the firebase-admin package as it is not compatible. Therefore we must manually retrieve the Oauth token for the google api. This excellent example from <a href="https://community.cloudflare.com/t/example-google-oauth-2-0-for-service-accounts-using-cf-worker/258220">cloudflare community</a> will get us started. Now that we are able to retrieve google Oauth tokens, we can use curl to test the apis from the command line.</p>
<p>Let us build the API for the in the workers that our website will use. We will have 3 rest API end points. One each for subStatus, sub and unsub. We will also add a function to send the notification. These are the 4 apis described above. We will also need to add worker secrets for SERVER_KEY and email address of service account in firebase and the private key.</p>
<h6>index.js(cloudflare worker)</h6>
<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>	<span class="token comment">/* Use the function provided in the example above and return the token*/</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">subStatus</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span><br>	<span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://iid.googleapis.com/iid/info/"</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>token <span class="token operator">+</span> <span class="token string">"?details=true"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token string">"key="</span> <span class="token operator">+</span> <span class="token constant">SERVER_KEY</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"GET"</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"failed"</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token literal-property property">subStatus</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>rel<span class="token operator">?.</span>topics<span class="token operator">?.</span>newPost <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">subUnsub</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span><br>	<span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://iid.googleapis.com/iid/v1:batch"</span> <span class="token operator">+</span> action<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"to"</span><span class="token operator">:</span> <span class="token string">"/topics/newPost"</span><span class="token punctuation">,</span> <span class="token string-property property">"registration_tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span>data<span class="token punctuation">.</span>token<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>			<span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token string">"key="</span> <span class="token operator">+</span> <span class="token constant">SERVER_KEY</span><span class="token punctuation">,</span><br>			<span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"failed"</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"success"</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sendNotification</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://fcm.googleapis.com/v1/projects/329859626245/messages:send"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>			<span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>				<span class="token string-property property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">"body"</span><span class="token operator">:</span> data<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"New Post!"</span><span class="token punctuation">,</span> <span class="token string-property property">"image"</span><span class="token operator">:</span> data<span class="token punctuation">.</span>image<span class="token punctuation">,</span> <span class="token string-property property">"tag"</span><span class="token operator">:</span> data<span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token string-property property">"url"</span><span class="token operator">:</span> data<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token punctuation">,</span><br>				<span class="token string-property property">"topic"</span><span class="token operator">:</span> <span class="token string">"newPost"</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>			<span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> <span class="token constant">GOOGLE_OAUTH_ACCESS_TOKEN</span><span class="token punctuation">,</span><br>			<span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"failed"</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"success"</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"here"</span><span class="token punctuation">)</span><br>	<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><br>	<span class="token keyword">let</span> response<br>	<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">const</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span> <span class="token operator">=</span> request<br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">switch</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				<span class="token keyword">case</span> <span class="token string">"/api/notify/sub"</span><span class="token operator">:</span><br>					response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">subUnsub</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Add"</span><span class="token punctuation">)</span><br>					<span class="token keyword">break</span><br>				<span class="token keyword">case</span> <span class="token string">"/api/notify/unsub"</span><span class="token operator">:</span><br>					response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">subUnsub</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Remove"</span><span class="token punctuation">)</span><br>					<span class="token keyword">break</span><br>				<span class="token keyword">case</span> <span class="token string">"/api/notify/subStatus"</span><span class="token operator">:</span><br>					response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">subStatus</span><span class="token punctuation">(</span><span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>					<span class="token keyword">break</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"Invalid URL"</span><span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span> <span class="token string-property property">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string-property property">'Access-Control-Allow-Credentials'</span><span class="token operator">:</span> <span class="token string">'true'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"fetch"</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> request <span class="token operator">=</span> event<span class="token punctuation">.</span>request<br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><br>		request<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">"POST"</span><br>	<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"here"</span><span class="token punctuation">)</span><br>		event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><br>			<span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>				<span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">405</span><span class="token punctuation">,</span><br>				<span class="token literal-property property">statusText</span><span class="token operator">:</span> <span class="token string">"Method Not Allowed"</span><span class="token punctuation">,</span><br>			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>		<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>You may notice that the <code>sendNotificaion</code> function is not being used. If you want to keep it simple and send the push notifications manually, you can add an api endpoint for the push notification but we will go one step further and automate it using CRON triggers so it will become clearer in just a bit. Now how do we automatically detect if the website has been updated. Well let us find out.</p>
<p>We need to create a new page on our website which will be a static website that will be updated with the details of the last post along with the time it was updated. We will use CRON triggers on the cloudflare worker to check periodically if there was a new post. If there is a new post we push notifications.</p>
<p>Now to compare if the date specified on the api is newer than the last notification, we must be able to store global variables in the worker script, that is where cloudflare kv comes in. Let us create a namespace for kv. Namespaces in cloudflare are nothing but a way to reference the objects in the worker script. Run the following command in the command line and save its output to &quot;wrangler.toml&quot;.</p>
<pre class="language-js"><code class="language-js">wrangler kv<span class="token operator">:</span>namespace create <span class="token string">"NOTIFICATIONS_KV_DB"</span></code></pre>
<p>Now let us add a function to check if there is a newer post. I use github pages for my static site so I used the raw user content file from the repository as my api. The return of the API is a JSON that has the required parameters. An example response is as below.</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span><span class="token string-property property">"Date"</span><span class="token operator">:</span> <span class="token number">1623083600005</span><span class="token punctuation">,</span><span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"Be selfish to be selfless"</span><span class="token punctuation">,</span><span class="token string-property property">"url"</span><span class="token operator">:</span><span class="token string">"/blog/posts/be-selfish-to-be-selfless/"</span><span class="token punctuation">,</span> <span class="token string-property property">"image"</span><span class="token operator">:</span><span class="token string">"/assets/images/manInSunset.jpg"</span><span class="token punctuation">,</span> <span class="token string-property property">"tag"</span><span class="token operator">:</span> <span class="token string">"Life"</span><span class="token punctuation">}</span></code></pre>
<h6>index.js(cloudflare worker)</h6>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">setCache</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=></span> <span class="token constant">NOTIFICATIONS_KV_DB</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"lastPostTime"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><br><span class="token keyword">const</span> <span class="token function-variable function">getCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">NOTIFICATIONS_KV_DB</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"lastPostTime"</span><span class="token punctuation">)</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkLatestPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"settimg cache"</span><span class="token punctuation">)</span><br>		lastBlogPost <span class="token operator">=</span> <span class="token number">0</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		lastBlogPost <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"&lt;Static JSON API>"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"GET"</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"failed"</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		<span class="token keyword">let</span> test <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"succeded "</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">)</span><br>		<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>lastBlogPost <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>Date<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">let</span> <span class="token constant">GOOGLE_OAUTH_ACCESS_TOKEN</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>			<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sendNotification</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><br>			<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>results <span class="token operator">===</span> <span class="token string">"success"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				lastBlogPost <span class="token operator">=</span> data<span class="token punctuation">.</span>Date<br>				<span class="token keyword">await</span> <span class="token function">setCache</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Date<span class="token punctuation">)</span><span class="token punctuation">)</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">results</span><span class="token operator">:</span> <span class="token string">"success"</span> <span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"scheduled"</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">checkLatestPost</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Now create a CRON trigger using wrangler with the appropriate duration.</p>
<h2>Eleventy Static API</h2>
<p>Creating a static API with eleventy is rather straightforward. We just need to create a template file similar to</p>
<h6>lastestPost.json</h6>
<pre class="language-js"><code class="language-js"><span class="token operator">--</span><span class="token operator">-</span><br><span class="token literal-property property">permalink</span><span class="token operator">:</span> <span class="token operator">/</span>api<span class="token operator">/</span>latestPost<span class="token punctuation">.</span>json<br><span class="token operator">--</span><span class="token operator">-</span><br><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">set</span> latestPost <span class="token operator">=</span> collections<span class="token punctuation">[</span><span class="token string">"post"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">%</span><span class="token punctuation">}</span><br><span class="token punctuation">{</span><span class="token string-property property">"Date"</span><span class="token operator">:</span> <span class="token number">1623083600005</span><span class="token punctuation">,</span><span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"{{latestPost.data.title}}"</span><span class="token punctuation">,</span><span class="token string-property property">"url"</span><span class="token operator">:</span><span class="token string">"{{latestPost.url}}"</span><span class="token punctuation">,</span> <span class="token string-property property">"image"</span><span class="token operator">:</span><span class="token string">"{{latestPost.data.mainImage}}"</span><span class="token punctuation">,</span> <span class="token string-property property">"tag"</span><span class="token operator">:</span> <span class="token string">"{{latestPost.data.tags[1]}}"</span><span class="token punctuation">}</span><br></code></pre>
<h2>Handling notifications on client</h2>
<p>Now that we have all the parts working, We now add the functions to add/remove user from topic and also check the status of the user. I will let the process of calling them based on the action of the users upto you. we can create the event handlers to handle the notification when it arrives.</p>
<h6>index.js</h6>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">enableNotifications</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">"granted"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		notificationToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token function">subscribteTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">"blocked"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Notification permissions have been blocked, enable notifications permission manually"</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">else</span> <span class="token punctuation">{</span><br>		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Now you will be asked for notification permissions"</span><span class="token punctuation">)</span><br>		notificationToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token function">subscribteTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function">subscribteTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token function">subUnsub</span><span class="token punctuation">(</span><span class="token string">"sub"</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">disableNotifications</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	notificationToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">subUnsub</span><span class="token punctuation">(</span><span class="token string">"unsub"</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">subUnsub</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token function">fetch</span><span class="token punctuation">(</span>notifyApiUrl <span class="token operator">+</span> action<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"token"</span><span class="token operator">:</span> notificationToken <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>			<span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>results <span class="token operator">===</span> <span class="token string">"success"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><br>			notificationStatus <span class="token operator">=</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">"sub"</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function">subStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>notifyApiUrl <span class="token operator">+</span> <span class="token string">"subStatus"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"token"</span><span class="token operator">:</span> notificationToken <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><br>		data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token keyword">return</span> data<br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br>messaging<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message received. '</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>Now finally to handling the notifications in the service worker. We create a notification object with the data that we receive from the push notification.</p>
<p><img src="/assets/images/mobNotif.jpg" alt="Mobile push notification" loading="lazy" width="757" height="1600"><em>Push notification on mobile</em></p>
<h6>firebase-messaging-sw.js</h6>
<pre class="language-js"><code class="language-js">messaging<span class="token punctuation">.</span><span class="token function">setBackgroundMessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[firebase-messaging-sw.js] Received background message '</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token comment">// Customize notification here</span><br>	<span class="token keyword">const</span> notificationTitle <span class="token operator">=</span> payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>title<span class="token punctuation">;</span><br>	<span class="token keyword">const</span> notificationOptions <span class="token operator">=</span> <span class="token punctuation">{</span><br>		<span class="token literal-property property">body</span><span class="token operator">:</span> payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>body<span class="token punctuation">,</span><br>		<span class="token literal-property property">image</span><span class="token operator">:</span> payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>image<span class="token punctuation">,</span><br>	<span class="token punctuation">}</span><span class="token punctuation">;</span><br>	myUrl <span class="token operator">=</span> payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">;</span><br>    self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'notificationclick'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">openWindow</span><span class="token punctuation">(</span>myUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        event<span class="token punctuation">.</span>notification<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>	self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>notificationTitle<span class="token punctuation">,</span>notificationOptions<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And voilà, there we have working push notifications whenever there is a new post on my website. I will add some common issues you may face.</p>
<h3>Note</h3>
<ul>
<li>CORS error when using testing with localhost. The <a href="https://support.cloudflare.com/hc/en-us/articles/200308847-Using-cross-origin-resource-sharing-CORS-with-Cloudflare">cloudflare example</a> will help.</li>
</ul>
<p>If you need any futher detail or the post is missing, please leave a comment or contact me via my <a href="mailto:raams.karthik@gmail.com">email</a>.</p>
<p>Until next time, turn on notification and sit tight!</p>

	</div>
	<div class="column col-3 hide-md pa1 post-content"></div>
	<div class="column col-9 pa1 col-md-12 justify-center">
		
			<h3>Similar Content</h3>
			<div class="suggested-postsList  grid-horizontal-scroll ">
	
		<a class="suggested-item" href="/blog/posts/creating-content-cards-using-css-grids-in-eleventy/">
			<img src="/assets/images/gridCards.png"  loading="lazy">
			<div class="content flex flex-column w-100 h-100">
				<h2 class="pa1">Creating content cards using C...</h2>
				<div class="description flex-grow-1"><p>I have always avoided CSS grids and preferred using flexboxes in places where grids would have been the better choice. I finally decided to overcom...</div>
				<div class="date">
					May 22, 2021
					<span aria-hidden="true">⋅</span><span>
								Tech</span></div>
			</div>
		</a>
	
		<a class="suggested-item" href="/blog/posts/adding-comments-to-eleventy-website-with-google-sheets-and-forms/">
			<img src="/assets/images/commentsMain.png"  loading="lazy">
			<div class="content flex flex-column w-100 h-100">
				<h2 class="pa1">Adding Comments to Eleventy We...</h2>
				<div class="description flex-grow-1"><p>During my latest redesign of my website, I explored Static Site Generators and ended up using eleventy. Contrary to popular belief, a static websit...</div>
				<div class="date">
					May 10, 2021
					<span aria-hidden="true">⋅</span><span>
								Tech</span></div>
			</div>
		</a>
	
</div>
			<div class="w-100 flex justify-end">
				<a class="blog-arrow" href="/blog">
	<span class="content">See all posts</span>
	<span class="icon">&#10132</span>
</a>
			</div>
		
	</div>
	<div class="column col-7 col-md-12 pa2">
		<h2 class="post-subtitle">Comments</h3>
<div id="commentSection" class="comments">
	<div id="no-comments" class="post-info no-comments">
		<p>There are currently no comments on this article, be the first to add one below!</p>
	</div>
</div>
<h3 class="post-subtitle">Add a Comment</h3>
<div id="auth" style="display:none;">
	<div class="post-info">
        You must authenticate with google in order to post comments.
    </div>
	<button class="google-button" onclick="authenticate()">
		<div class="d-flex justify-center items-center">
			<svg viewBox="0 0 256 262" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid"><path d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027" fill="#4285F4"/><path d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1" fill="#34A853"/><path d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782" fill="#FBBC05"/><path d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251" fill="#EB4335"/></svg> Authenticate with Google
    </div>
	</button>
</div>
<div class="comments" id="comments-form">
	<div id="user" class="user">
		<img class="image" id="image">
		<span class="name" id="name"></span>
		<button class="button" id="button" onclick="signOut()">Sign Out</button>
	</div>
	<form onsubmit="return checkform()" action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSdeT6VPXKvg5NLo2socJFISOGxkENzV3b1vYacoK8xr-ns7Lg/formResponse" target="comments_hidden_iframe" id="comment-form" autocomplete="off">
		<input name="entry.1738070516" type="text" value="/blog/posts/adding-push-notifications-to-static-sites/" style="display:none">
		<input name="entry.1638622064" type="text" id="email" style="display:none">
		<input name="entry.1593505758" type="text" id="userName" style="display:none">
		<div class="group" style="flex-grow:1;">
			<textarea id="comment-content" maxlength=140 name="entry.1851568030" form="comment-form" required=""></textarea>
			<span class="bar"></span>
			<label>Type in your comment</label>
		</div>
		<input id="comment-submit" class="submitButton" type="submit" value="Post">
	</form>
</div>
<iframe name="comments_hidden_iframe" id="comments_hidden_iframe" style="display:none;"></iframe>
	</div>
</div>
				</div>
				<div class="flex-shrink footer">
	<div class="divider"></div>
	<div class="flex w-100 justify-center items-center flex-column">
		<div class="w-100 tc mt1">
			<a href="https://github.com/karthik2804" aria-label="github" class="social"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
			<a href="https://www.linkedin.com/in/karthik-ganeshram-053830153/" aria-label="linkedin" class="social"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>
			<a href="https://www.instagram.com/karthik_ganeshram/" aria-label="instagram" class="social"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-instagram"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a>
			<a href="https://twitter.com/karthikganeshr1" aria-label="twitter" class="social"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
		</div>
		<div class="w-100 flex justify-around items-center pa1">
			<a href="/privacy-policy">
				<small>Privacy Policy</small>
			</a>
			<a href="mailto:raams.karthik@gmail.com">
				<small>Contact me!</small>
			</a>
			<a href="/reading-list">
				<small>Reading List</small>
			</a>
			<a href="/blog-roll">
				<small>Blog Roll</small>
			</a>
		</div>
		<div class="w-100 mb1 tc" >
			<small class="copyright"> 2021 © Copyright to Karthik Ganeshram</small>
		</div>
	</div>
	<div>
			</div>
		</div>
		<script src="/assets/js/index.js"></script>
		
			
				<script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-app.js"></script>
			
		
			
				<script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-auth.js"></script>
			
		
			
				<script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-messaging.js"></script>
			
		
			
				<script src="/assets/js/firebase.js"></script>
			
		
			
				<script src="/assets/js/comments.js"></script>
			
		
	</body>
</html>